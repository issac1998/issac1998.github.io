---
title:  "GMP "
search: true
categories:
  - Jekyll
  - Go
  - codes
  - src
last_modified_at: 2025-07-01T03:06:00-05:00
---
这篇文章介绍GO的栈管理，包含分配、扩容、缩容等逻辑，只会描述具体的栈操作函数，上层的调用不会展开介绍

分配栈逻辑；
1.小栈优先于mcache 分配
2\4\8\16 K分别有不同的fixed-size free-list allocator
如果对应大小的 stackcache 获取不到，那么调用 stackcacherefill ，stackcacherefill调用stackpooalloc从堆上申请一片内存空间填充到stackcache中。

例外情况： thisg.m.p == 0可能发生在系统调用 exitsyscall 或改变 P 的个数 procresize 时，thisg.m.preemptoff != ""会发生在 GC 的时候。也就是说在发生在系统调用 exitsyscall 或改变 P 的个数在变动，亦或是在 GC 的时候，调用stackpoolalloc从 stackpool 分配栈空间，否则从 mcache 中获取。


2.大栈从堆上分配，也是首先尝试从stackLarge.free分配，不行再调用allocManual从堆上分配内存


a. stackpoolalloc
 首先尝试从stackpool[order].item.span获取，如果不行，再调用allocManual分配。
  allocManual调用 allocspan，具体内容看内存分配（ https://www.luozhiyun.com/archives/434 ）

b.stackcacherefill 函数会调用 stackpoolalloc 从 stackpool 中获取一半的空间组装成 list 链表，然后放入到 stackcache 数组中。

可见，最终分配具体空间都是通过allocManul执行的，且执行完后都会调用OsStackAlloc initial这段空间

栈的新建


 b.若找不到，创建新g:malg分配栈空间（这里只分配内存空间，例如设置stackguard，stack.hi,stakc.lo，空间分配：小栈从当前P或全局cache中分配，如果栈比较大，会在全局大cache或heap上新建），设置状态为gdead（目的是不让GC scan），将g放入全局G列表。


 High Address (newg.stack.hi)
+---------------------------+
|                           |
|      Available Stack     |
|         Space             |
|                           |
+---------------------------+ <- newg.stackguard0 = newg.stack.lo + stackGuard
|      Stack Guard          |
|      (Red Zone)           |
+---------------------------+ <- newg.stack.lo (cleared to 0)
Low Address

c.初始化栈帧（设置SP，初始化栈帧内容）

High Address (newg.stack.hi)
+---------------------------+
|                           |
|      未使用的栈空间        |
|                           |
+---------------------------+ <- sp (初始栈指针)
|     初始栈帧              |
|   (totalSize大小)         |
|   - 返回地址              |
|   - 参数空间              |
|   - LR寄存器值            |
+---------------------------+
|                           |
|      剩余栈空间           |
|                           |
+---------------------------+ <- stackguard0
|      Stack Guard          |
+---------------------------+ <- newg.stack.lo
Low Address
d.设置sched中sp,pc,g等信息
e.设置父goroutine，go的pc
f.设置pprod
g.分配goid，状态为runable
h.设置race检测
i.释放m